<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sharklog App v52</title>
    
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="apple-touch-icon" href="https://i.imgur.com/ryw3NT7.jpeg">
    <link rel="icon" type="image/jpeg" href="https://i.imgur.com/ryw3NT7.jpeg">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-body: #020617;
            --surface: #1e293b;
            --primary: #06b6d4; --primary-glow: rgba(6, 182, 212, 0.4);
            --success: #10b981; --warning: #f59e0b; --danger: #ef4444;
            --text-main: #f8fafc; --text-sec: #94a3b8;
            --border: 1px solid rgba(255, 255, 255, 0.08);
            --glass: rgba(30, 41, 59, 0.85);
            --radius: 18px;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background-color: var(--bg-body); background-image: radial-gradient(at 0% 0%, #1e1b4b 0px, transparent 50%), radial-gradient(at 100% 100%, #0f172a 0px, transparent 50%); color: var(--text-main); margin: 0; padding: 15px; min-height: 100vh; font-size: 14px; }
        .container { max-width: 600px; margin: 0 auto; padding-bottom: 100px; }

        /* HEADER */
        .header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; padding: 10px 5px; }
        .header h1 { margin: 0; font-size: 20px; font-weight: 900; letter-spacing: -0.5px; background: linear-gradient(90deg, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logo-img { width: 45px; height: 45px; border-radius: 12px; box-shadow: 0 0 15px var(--primary-glow); border: 2px solid rgba(255,255,255,0.1); }

        /* NAV */
        .date-nav { display: flex; justify-content: space-between; align-items: center; background: var(--surface); padding: 10px 15px; border-radius: 16px; margin-bottom: 20px; border: var(--border); }
        .nav-btn { background: none; border: none; color: var(--primary); font-size: 22px; cursor: pointer; }
        #labelMesAno { font-weight: 800; font-size: 14px; text-transform: uppercase; }

        /* KPI */
        .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 25px; }
        .card { background: var(--glass); backdrop-filter: blur(12px); border-radius: var(--radius); border: var(--border); padding: 16px; position: relative; overflow: hidden; box-shadow: 0 8px 15px rgba(0,0,0,0.3); }
        .kpi-title { font-size: 10px; text-transform: uppercase; color: var(--text-sec); font-weight: 700; margin-bottom: 5px; }
        .kpi-val { font-size: 18px; font-weight: 800; color: #fff; }
        .card.full { grid-column: span 2; background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(6, 78, 59, 0.3)); border-color: rgba(16, 185, 129, 0.3); }
        .card.full .kpi-val { font-size: 26px; text-shadow: 0 0 20px rgba(16, 185, 129, 0.4); }

        /* TABS */
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .tab-btn { flex: 1; background: var(--surface); color: var(--text-sec); border: var(--border); padding: 12px; border-radius: 14px; font-weight: 700; font-size: 11px; cursor: pointer; white-space: nowrap; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: #000; border-color: var(--primary); box-shadow: 0 0 15px var(--primary-glow); }

        /* INPUTS */
        label { display: block; font-size: 11px; color: var(--primary); font-weight: 700; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        input, select, textarea { width: 100%; background: #0f172a; border: 1px solid var(--surface-light); padding: 14px; border-radius: 14px; color: white; font-size: 15px; transition: 0.3s; margin-bottom: 10px; }
        input:focus, select:focus { border-color: var(--primary); }

        /* BUTTONS */
        .btn { width: 100%; border: none; padding: 16px; border-radius: 14px; font-size: 13px; font-weight: 800; text-transform: uppercase; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 5px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: linear-gradient(135deg, var(--primary), #0284c7); color: #fff; box-shadow: 0 5px 15px rgba(6, 182, 212, 0.3); }
        .btn-success { background: linear-gradient(135deg, var(--success), #059669); color: #fff; }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #b91c1c); color: #fff; }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #d97706); color: #000; }
        .btn-manual { background: var(--surface-light); border: 1px solid var(--primary); color: var(--primary); }

        /* TABLE */
        .table-container { background: var(--surface); border-radius: 18px; border: var(--border); overflow: hidden; margin-top: 20px; }
        .table-scroll { max-height: 350px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #1e293b; color: var(--text-sec); font-size: 10px; text-transform: uppercase; font-weight: 800; position: sticky; top: 0; }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 13px; color: #cbd5e1; }
        
        .tag { padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: 800; text-transform: uppercase; cursor: pointer; border: none; }
        .tag-hosp { background: rgba(96, 165, 250, 0.2); color: #60a5fa; }
        .tag-extra { background: rgba(167, 139, 250, 0.2); color: #a78bfa; }

        .area { display: none; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; justify-content: center; align-items: center; padding: 20px; backdrop-filter: blur(5px); }
        .modal-content { background: var(--surface); padding: 25px; border-radius: 24px; width: 100%; max-width: 400px; border: 1px solid var(--primary); }
    </style>
</head>
<body>

<div class="container">
    
    <div class="header">
        <div class="header-text"><h1>SHARKLOG</h1><p id="clock">--:--</p></div>
        <img src="https://i.imgur.com/ryw3NT7.jpeg" class="logo-img" alt="Logo">
    </div>

    <div class="date-nav">
        <button class="nav-btn" onclick="mudarMes(-1)">‚ùÆ</button>
        <span id="labelMesAno">CARREGANDO...</span>
        <button class="nav-btn" onclick="mudarMes(1)">‚ùØ</button>
    </div>

    <div class="kpi-grid">
        <div class="card full">
            <div class="kpi-title">‚ú® Lucro L√≠quido Real</div>
            <div class="kpi-val" id="txtLucroReal" style="color: var(--success);">R$ 2.000,00</div>
        </div>
        <div class="card"><div class="kpi-title">üè• Hospital</div><div class="kpi-val" id="txtHosp">R$ 2.000,00</div></div>
        <div class="card"><div class="kpi-title">üçî Lanche/Extras</div><div class="kpi-val" id="txtOutros">R$ 0,00</div></div>
        <div class="card"><div class="kpi-title" style="color:var(--danger)">üí∏ Custos</div><div class="kpi-val" id="txtCustos" style="color:var(--danger)">R$ 0,00</div></div>
        <div class="card"><div class="kpi-title" style="color:#a78bfa">üèçÔ∏è KM M√™s</div><div class="kpi-val" id="txtKMMes" style="color:#a78bfa">0 KM</div></div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="abrirAba('areaHome', this)">üè† IN√çCIO</button>
        <button class="tab-btn" onclick="abrirAba('areaGraficos', this)">üìä GR√ÅFICO</button>
        <button class="tab-btn" onclick="abrirAba('areaDespesas', this)">üí∏ GASTOS</button>
        <button class="tab-btn" onclick="abrirAba('areaManutencao', this)">üõ†Ô∏è MOTO</button>
    </div>

    <div id="areaHome" class="area" style="display:block;">
        <div class="card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <label>NOVA CORRIDA</label>
                <button onclick="toggleConfig()" style="background:none; border:none; font-size:20px; cursor:pointer;">‚öôÔ∏è</button>
            </div>
            
            <select id="selDestino" onchange="checkSelecao()">
                <option value="blumenau" data-valor="0" data-km="124">üè• Blumenau (HEMOSC)</option>
                <option value="itapema" data-valor="150" data-km="102">üè• Itapema</option>
                <option value="itajai" data-valor="80" data-km="24">üè• Itaja√≠</option>
                <option value="cis" data-valor="0" data-km="13">üè• CIS - Navegantes</option>
                <option value="bc" data-valor="100" data-km="43">üè• Balne√°rio Cambori√∫</option>
                <option value="lanchonete">üçî Lanchonete (Bico)</option>
                <option value="outros">‚ö° Extras</option>
            </select>

            <div id="divExtras" style="display:none; animation:fadeIn 0.3s;">
                <label>T√≠tulo / Cliente</label><input type="text" id="extTitulo" placeholder="Ex: Entrega Documento">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Valor (R$)</label><input type="text" id="extV"></div>
                    <div><label>KM Total</label><input type="number" id="extK"></div>
                </div>
            </div>

            <input type="text" id="corridaObs" placeholder="Observa√ß√£o (Opcional)">

            <div id="abaConfigs" style="display:none; background:#0f172a; padding:15px; border-radius:16px; margin:10px 0; border:1px solid var(--primary);">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Gasolina</label><input type="text" id="cfgGas"></div>
                    <div><label>KM/L</label><input type="text" id="cfgCons"></div>
                    <div><label>√ìleo</label><input type="text" id="cfgOleo"></div>
                    <div><label>Rela√ß√£o</label><input type="text" id="cfgRel"></div>
                    <div><label>Pneu D.</label><input type="text" id="cfgPD"></div>
                    <div><label>Pneu T.</label><input type="text" id="cfgPT"></div>
                </div>
                <button onclick="saveCfg()" class="btn btn-primary">SALVAR CUSTOS</button>
            </div>

            <div id="botoesIniciais" style="display:flex; gap:10px; margin-top:10px;">
                <button id="btnTimer" class="btn btn-primary" onclick="motor()">üöÄ INICIAR TIMER</button>
                <button id="btnManual" class="btn btn-manual" style="display:none;" onclick="ativarModoManual()">üìù LAN√áAR MANUAL</button>
            </div>

            <div id="liveMonitor" style="display:none; text-align:center; padding:15px; background:rgba(6,182,212,0.1); border-radius:15px; border:1px solid var(--primary); margin:15px 0;">
                <div style="font-size:36px; font-weight:900; font-family:monospace;" id="timer">00:00:00</div>
                <button onclick="motor()" class="btn btn-danger" style="margin-top:10px;">üõë FINALIZAR</button>
            </div>

            <div id="painelFinalizacao" style="display:none; margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px;">
                <h4 style="margin:0 0 10px 0; color:var(--success); text-align:center;">DETALHES DO REGISTRO</h4>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div><label>Data</label><input type="date" id="inputDataManual"></div>
                    <div><label>Hora</label><input type="time" id="inputHoraManual"></div>
                </div>

                <div id="divAjusteKM">
                    <label style="color:var(--warning);">KM TOTAL DA VIAGEM</label>
                    <input type="number" id="ajusteKMFinal">
                </div>

                <button onclick="salvar()" class="btn btn-success">üíæ SALVAR NO HIST√ìRICO</button>
                <button onclick="cancelarLancamento()" class="btn" style="background:#334155; color:white; margin-top:10px;">CANCELAR</button>
            </div>

        </div>
    </div>

    <div id="areaGraficos" class="area"><div class="card"><div style="height:250px;"><canvas id="graficoLucro"></canvas></div></div></div>
    
    <div id="areaDespesas" class="area"><div class="card" style="border-color:var(--danger);"><label style="color:var(--danger)">NOVO GASTO</label><input type="text" id="despNome" placeholder="Descri√ß√£o"><input type="text" id="despValor" placeholder="Valor R$"><textarea id="despObs" placeholder="Obs..."></textarea><button onclick="addDespesa()" class="btn btn-danger">SALVAR GASTO</button></div></div>
    
    <div id="areaManutencao" class="area"><div class="card" style="border-color:var(--warning);"><label style="color:var(--warning)">MANUTEN√á√ÉO</label><input type="text" id="manutPeca" placeholder="Pe√ßa"><input type="text" id="manutMarca" placeholder="Marca"><div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;"><input type="text" id="manutValor" placeholder="R$"><input type="number" id="manutKM" placeholder="KM Painel"></div><textarea id="manutObs" placeholder="Obs..."></textarea><button onclick="addManutencao()" class="btn btn-warning">SALVAR</button></div></div>

    <div class="table-container">
        <div style="padding:15px; display:flex; gap:10px; overflow-x:auto;">
            <button class="tag tag-hosp" onclick="filtrarTabela('todos')">TUDO</button>
            <button class="tag tag-hosp" onclick="filtrarTabela('Hospital')">HOSP</button>
            <button class="tag tag-extra" onclick="filtrarTabela('Extra')">EXTRA</button>
            <button class="tag tag-extra" onclick="filtrarTabela('Lanches')">LANCHE</button>
        </div>
        <div class="table-scroll"><table><thead><tr><th>Hist√≥rico</th><th style="text-align:right">Valor</th></tr></thead><tbody id="corpoTabelaApp"></tbody></table></div>
    </div>

    <div class="card" style="margin-top:20px;">
        <label>RELAT√ìRIOS E BACKUP</label>
        <button class="btn btn-success" onclick="gerarCSVHospital()">üìÑ HOSPITAL (12-12)</button>
        <button class="btn btn-primary" onclick="gerarCSVContabil()">üìà GERAL MENSAL</button>
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px;">
            <button class="btn" style="background:#334155; color:white;" onclick="exportarBackup()">‚¨áÔ∏è EXPORTAR</button>
            <button class="btn" style="background:#334155; color:white;" onclick="importarBackup()">‚¨ÜÔ∏è IMPORTAR</button>
        </div>
    </div>
</div>

<div id="modal"><div class="modal-content"><div id="modalBody"></div><button onclick="apagarRegistroAtual()" class="btn btn-danger" style="margin-top:20px;">üóëÔ∏è EXCLUIR</button><button onclick="fecharModal()" class="btn" style="margin-top:10px; background:#334155; color:white;">FECHAR</button></div></div>

<script>
    const DB_KEY = "SHARKLOG_DATA_V50";
    let db = JSON.parse(localStorage.getItem(DB_KEY)) || { registros: [], despesas: [], manutencao: [], cfg: {gas:6.54, cons:35, oleo:45, rel:160, pd:220, pt:290} };
    let dataVis = new Date(), tIn, cron, espR$ = 0, cKM = 0, chartInstance = null, filtroAtual = 'todos', idAtual = null, tipoAtual = null;

    // Rel√≥gio
    setInterval(() => { const now = new Date(); document.getElementById('clock').innerText = now.toLocaleDateString('pt-BR').substring(0,5) + ' ' + now.toLocaleTimeString('pt-BR').substring(0,5); }, 1000);

    // Helpers
    function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(db)); }
    function parseMoney(v) { return v ? parseFloat(v.toString().replace(',', '.')) : 0; }
    function toggleConfig() { const el = document.getElementById('abaConfigs'); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
    function mudarMes(d) { dataVis.setMonth(dataVis.getMonth() + d); render(); }
    function fecharModal() { document.getElementById('modal').style.display = 'none'; }
    function abrirAba(id, btn) { document.querySelectorAll('.area').forEach(a => a.style.display = 'none'); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(id).style.display = 'block'; btn.classList.add('active'); if(id === 'areaGraficos') setTimeout(renderChart, 100); }
    function filtrarTabela(tipo) { filtroAtual = tipo; render(); }

    function saveCfg() {
        db.cfg = { gas: parseMoney(document.getElementById('cfgGas').value), cons: parseMoney(document.getElementById('cfgCons').value) || 1, oleo: parseMoney(document.getElementById('cfgOleo').value), rel: parseMoney(document.getElementById('cfgRel').value), pd: parseMoney(document.getElementById('cfgPD').value), pt: parseMoney(document.getElementById('cfgPT').value) };
        saveDB(); render(); alert('Salvo!');
    }

    // --- L√ìGICA DE INTERFACE ---
    function checkSelecao() {
        const v = document.getElementById('selDestino').value;
        const isExtra = (v === 'lanchonete' || v === 'outros');
        
        // Mostra campos extras se necess√°rio
        document.getElementById('divExtras').style.display = isExtra ? 'block' : 'none';
        
        // Bot√£o Manual aparece s√≥ pra Lanche/Outros (para facilitar)
        document.getElementById('btnManual').style.display = isExtra ? 'flex' : 'none';
        
        // Ajusta label do KM
        document.getElementById('ajusteKMFinal').value = document.getElementById('selDestino').options[document.getElementById('selDestino').selectedIndex].getAttribute('data-km');
    }

    function motor() {
        tIn = new Date();
        document.getElementById('botoesIniciais').style.display = 'none';
        document.getElementById('liveMonitor').style.display = 'block';
        cron = setInterval(() => { 
            const diff = new Date() - tIn; 
            document.getElementById('timer').innerText = new Date(diff).toISOString().substr(11, 8);
            espR$ = Math.floor(diff/60000) >= 15 ? Math.floor(Math.floor(diff/60000)/15)*10 : 0;
        }, 1000);
    }

    function ativarModoManual() {
        document.getElementById('botoesIniciais').style.display = 'none';
        mostrarPainelFinalizacao();
    }

    function mostrarPainelFinalizacao() {
        clearInterval(cron);
        document.getElementById('liveMonitor').style.display = 'none';
        document.getElementById('painelFinalizacao').style.display = 'block';
        
        // Preenche data e hora atual
        const agora = new Date();
        // Ajuste fuso hor√°rio simples
        const offset = agora.getTimezoneOffset() * 60000;
        const localISOTime = (new Date(agora - offset)).toISOString().slice(0, -1);
        
        document.getElementById('inputDataManual').value = localISOTime.split('T')[0];
        document.getElementById('inputHoraManual').value = localISOTime.split('T')[1].substring(0,5);

        // Se for extra, esconde o campo de KM do painel final (pq ja tem no divExtras)
        const v = document.getElementById('selDestino').value;
        const isExtra = (v === 'lanchonete' || v === 'outros');
        document.getElementById('divAjusteKM').style.display = isExtra ? 'none' : 'block';
    }

    function cancelarLancamento() {
        clearInterval(cron);
        document.getElementById('painelFinalizacao').style.display = 'none';
        document.getElementById('liveMonitor').style.display = 'none';
        document.getElementById('botoesIniciais').style.display = 'flex';
        document.getElementById('timer').innerText = "00:00:00";
    }

    function salvar() {
        const modo = document.getElementById('selDestino').value;
        const opt = document.getElementById('selDestino').options[document.getElementById('selDestino').selectedIndex];
        
        const dataManual = document.getElementById('inputDataManual').value;
        const horaManual = document.getElementById('inputHoraManual').value;
        if(!dataManual || !horaManual) return alert("Data e Hora obrigat√≥rias!");

        const [ano, mes, dia] = dataManual.split('-');
        
        let kmV = 0, valorBruto = 0, tipo = '', local = '';

        if(modo === 'lanchonete' || modo === 'outros') {
            kmV = parseMoney(document.getElementById('extK').value);
            valorBruto = parseMoney(document.getElementById('extV').value);
            tipo = (modo==='lanchonete'?'Lanches':'Extra');
            local = document.getElementById('extTitulo').value || (modo==='lanchonete'?'Lanchonete':'Extra');
        } else {
            kmV = parseMoney(document.getElementById('ajusteKMFinal').value) || parseFloat(opt.getAttribute('data-km'));
            valorBruto = parseFloat(opt.getAttribute('data-valor')) + espR$;
            tipo = 'Hospital';
            local = opt.text.replace('üè• ', '');
        }

        let item = {
            id: Date.now(),
            obs: document.getElementById('corridaObs').value,
            mes: mes, ano: parseInt(ano),
            data: `${dia}/${mes}/${ano}`, hora: horaManual,
            custo: kmV * cKM, km: kmV,
            bruto: valorBruto, tipo: tipo, local: local, tipoItem: 'VIAGEM'
        };

        db.registros.push(item);
        saveDB(); location.reload();
    }

    // --- OUTROS ---
    function addManutencao() {
        const peca = document.getElementById('manutPeca').value.toUpperCase();
        const v = parseMoney(document.getElementById('manutValor').value);
        const k = parseInt(document.getElementById('manutKM').value);
        if(!peca || !k) return alert('Preencha os campos!');
        
        // Logica durabilidade
        const hist = db.manutencao.filter(m => m.peca.includes(peca)).sort((a,b)=>b.km-a.km);
        let delta = 0; if(hist.length>0) { delta = k - hist[0].km; if(delta>0) alert(`Durou ${delta} KM`); }

        const d = new Date();
        db.manutencao.push({ id: Date.now(), peca, marca: document.getElementById('manutMarca').value, obs: document.getElementById('manutObs').value, valor: v, km: k, duracao: delta, data: d.toLocaleDateString('pt-BR'), mes: String(d.getMonth()+1).padStart(2,'0'), ano: d.getFullYear(), tipoItem: 'MANUT' });
        saveDB(); location.reload();
    }

    function addDespesa() {
        const n = document.getElementById('despNome').value, v = parseMoney(document.getElementById('despValor').value);
        if(n && v) { const d = new Date(); db.despesas.push({ id: Date.now(), desc: n, valor: v, obs: document.getElementById('despObs').value, data: d.toLocaleDateString('pt-BR'), mes: String(d.getMonth()+1).padStart(2,'0'), ano: d.getFullYear(), tipoItem: 'GASTO' }); saveDB(); location.reload(); }
    }

    // RENDER
    function render() {
        cKM = (db.cfg.gas/db.cfg.cons) + (db.cfg.oleo/1000) + (db.cfg.rel/15000) + (db.cfg.pd/15000) + (db.cfg.pt/12000);
        document.getElementById('cfgGas').value = db.cfg.gas; document.getElementById('cfgCons').value = db.cfg.cons; 
        const mIdx = dataVis.getMonth(), aVis = dataVis.getFullYear(), mStr = String(mIdx+1).padStart(2,'0');
        document.getElementById('labelMesAno').innerText = `${["JANEIRO","FEVEREIRO","MAR√áO","ABRIL","MAIO","JUNHO","JULHO","AGOSTO","SETEMBRO","OUTUBRO","NOVEMBRO","DEZEMBRO"][mIdx]} / ${aVis}`;
        
        const rM = db.registros.filter(r => r.mes === mStr && r.ano === aVis);
        const dM = db.despesas.filter(d => d.mes === mStr && d.ano === aVis);
        const mM = db.manutencao.filter(m => m.mes === mStr && m.ano === aVis);
        
        let tH = 2000, tO = 0, tC = 0, tK = 0;
        rM.forEach(r => { if(r.tipo === 'Hospital') tH += r.bruto; else tO += r.bruto; tC += r.custo; tK += r.km; });
        dM.forEach(d => tC += d.valor); mM.forEach(m => tC += m.valor);

        document.getElementById('txtHosp').innerText = tH.toLocaleString('pt-br',{style:'currency',currency:'BRL'});
        document.getElementById('txtOutros').innerText = tO.toLocaleString('pt-br',{style:'currency',currency:'BRL'});
        document.getElementById('txtCustos').innerText = tC.toLocaleString('pt-br',{style:'currency',currency:'BRL'});
        document.getElementById('txtKMMes').innerText = tK.toFixed(1) + " KM";
        document.getElementById('txtLucroReal').innerText = (tH + tO - tC).toLocaleString('pt-br',{style:'currency',currency:'BRL'});

        const tbody = document.getElementById('corpoTabelaApp'); tbody.innerHTML = '';
        let lista = [ ...rM.map(x=>({...x, c:'var(--success)'})), ...dM.map(x=>({...x, local:x.desc, bruto:0, v:x.valor*-1, c:'var(--danger)'})), ...mM.map(x=>({...x, local:x.peca, bruto:0, v:x.valor*-1, c:'var(--warning)'})) ].sort((a,b)=>b.id-a.id);
        if(filtroAtual !== 'todos') lista = lista.filter(x => x.tipo === filtroAtual);
        
        lista.forEach(i => {
            tbody.innerHTML += `<tr onclick="verDetalhes(${i.id}, '${i.tipoItem}')"><td><b>${i.local}</b><br><small>${i.data} ${i.hora || ''}</small></td><td style="text-align:right; color:${i.c}">R$ ${Math.abs(i.bruto || i.valor).toFixed(2)}</td></tr>`;
        });
    }

    // BACKUP
    function exportarBackup() { const dataStr = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-'); const blob = new Blob([JSON.stringify(db)], { type: 'application/json' }); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `Sharklog_Backup_${dataStr}.json`; a.click(); }
    function importarBackup() { const input = document.createElement('input'); input.type = 'file'; input.accept = '.json'; input.onchange = e => { const f = e.target.files[0]; const r = new FileReader(); r.onload = ev => { try { const d = JSON.parse(ev.target.result); if(d.registros) { db = d; saveDB(); alert("Sucesso!"); location.reload(); } else alert("Arquivo inv√°lido"); } catch(e){ alert("Erro arquivo"); } }; r.readAsText(f); }; input.click(); }

    function gerarCSVHospital() {
        const mesRef = dataVis.getMonth(), anoRef = dataVis.getFullYear();
        const dtFim = new Date(anoRef, mesRef, 12, 23, 59, 59); const dtIni = new Date(anoRef, mesRef - 1, 13, 0, 0, 0);
        const vHosp = db.registros.filter(r => { if(r.tipo !== 'Hospital') return false; const [d,m,a] = r.data.split('/'); const dR = new Date(a, m-1, d); return dR >= dtIni && dR <= dtFim; });
        const agrupado = { "Contrato Fixo Mensal": { qtd: 1, valor: 2000 } }; vHosp.forEach(v => { if (!agrupado[v.local]) agrupado[v.local] = { qtd: 0, valor: 0 }; agrupado[v.local].qtd++; agrupado[v.local].valor += v.bruto; });
        let csv = `Relatorio Hospital\nDestino;Qtd;Valor\n`; let tQ = 0, tV = 0; for (let d in agrupado) { tQ+=agrupado[d].qtd; tV += agrupado[d].valor; csv += `${d};${agrupado[d].qtd};${agrupado[d].valor.toFixed(2).replace('.',',')}\n`; } csv += `Total;${tQ};${tV.toFixed(2).replace('.',',')}`; const b = new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'}); const l = document.createElement("a"); l.href = URL.createObjectURL(b); l.download = "Hospital.csv"; document.body.appendChild(l); l.click(); document.body.removeChild(l);
    }

    function gerarCSVContabil() {
        const mStr = String(dataVis.getMonth()+1).padStart(2,'0'), aVis = dataVis.getFullYear();
        const todos = [ ...db.registros.filter(r => r.mes === mStr && r.ano === aVis), ...db.despesas.filter(d => d.mes === mStr && d.ano === aVis).map(d => ({...d, local: d.desc, bruto: 0, custo: d.valor, km: 0})), ...db.manutencao.filter(m => m.mes === mStr && m.ano === aVis).map(m => ({...m, local: 'MOTO: '+m.peca, bruto: 0, custo: m.valor, km: 0})) ].sort((a,b) => a.id - b.id);
        let csv = `Geral\nDATA;OBS;DESCRICAO;KM;RECEITA;CUSTO;LUCRO\n`; todos.forEach(i => { csv += `${i.data};${i.obs||''};${i.local};${(i.km||0).toString().replace('.',',')};${(i.bruto||0).toFixed(2).replace('.',',')};${(i.custo||0).toFixed(2).replace('.',',')};${((i.bruto||0)-(i.custo||0)).toFixed(2).replace('.',',')}\n`; }); const b = new Blob(["\uFEFF"+csv],{type:'text/csv;charset=utf-8;'}); const l = document.createElement("a"); l.href = URL.createObjectURL(b); l.download = "Geral.csv"; document.body.appendChild(l); l.click(); document.body.removeChild(l);
    }

    function verDetalhes(id, tipo) { idAtual = id; tipoAtual = tipo; const item = (tipo==='VIAGEM' ? db.registros : (tipo==='GASTO' ? db.despesas : db.manutencao)).find(x => x.id === id); let h = `<p><b>Data:</b> ${item.data}</p><p><b>Local:</b> ${item.local || item.peca || item.desc}</p><p><b>Valor:</b> R$ ${(item.bruto || item.valor).toFixed(2)}</p>`; if(item.obs) h += `<p><b>Obs:</b> ${item.obs}</p>`; document.getElementById('modalBody').innerHTML = h; document.getElementById('modal').style.display = 'flex'; }
    function apagarRegistroAtual() { if(confirm('Excluir?')) { if(tipoAtual==='VIAGEM') db.registros = db.registros.filter(x=>x.id!==idAtual); else if(tipoAtual==='GASTO') db.despesas = db.despesas.filter(x=>x.id!==idAtual); else db.manutencao = db.manutencao.filter(x=>x.id!==idAtual); saveDB(); location.reload(); } }

    render();
    checkSelecao();
</script>
</body>
</html>
